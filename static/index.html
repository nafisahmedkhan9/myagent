<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nafis Ahmed Khan - AI Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            position: relative;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .header h1 {
            font-size: 1.1em;
            margin: 0;
            font-weight: 600;
        }

        .header p {
            display: none;
        }

        .header-controls {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
        }

        .close-button, .new-chat-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .new-chat-button {
            font-size: 14px;
        }

        .close-button:hover, .new-chat-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 20px 100px 20px;
            background: white;
            scroll-behavior: smooth;
        }

        .messages::-webkit-scrollbar {
            width: 4px;
        }

        .messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 2px;
        }

        .messages::-webkit-scrollbar-thumb:hover {
            background: #bbb;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
        }

        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            text-align: right;
            max-width: 80%;
        }

        .bot-message {
            background: #f1f3f4;
            color: #333;
            margin-right: auto;
            max-width: 80%;
            border: 1px solid #e1e5e9;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        .input-form {
            background: white;
            padding: 16px 20px 20px 20px;
            border-top: 1px solid #e1e5e9;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .message-input {
            width: 100%;
            padding: 12px 50px 12px 16px;
            border: 1px solid #e1e5e9;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            background: #f8f9fa;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .message-input:focus {
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .message-input::placeholder {
            color: #6c757d;
        }

        .send-button {
            position: absolute;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            color: white;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .send-button:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .send-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: translateY(-50%) scale(1);
        }

        .typing {
            color: #6c757d;
            font-style: italic;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .error {
            background: #dc3545;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }
            
            .header h1 {
                font-size: 1em;
            }
            
            .header-icon {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
            
            .messages {
                padding: 16px 16px 100px 16px;
            }
            
            .message {
                max-width: 85%;
                padding: 10px 14px;
                font-size: 14px;
            }
            
            .input-form {
                padding: 12px 16px 16px 16px;
            }
            
            .message-input {
                padding: 10px 45px 10px 14px;
                font-size: 14px;
            }
            
            .send-button {
                width: 28px;
                height: 28px;
                right: 20px;
                font-size: 12px;
            }
            
            .close-button {
                width: 28px;
                height: 28px;
                font-size: 14px;
                right: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-icon" id="headerIcon">ðŸ¤–</div>
                <h1 id="headerTitle">Virtual Assistant</h1>
            </div>
            <div class="header-controls">
                <button class="new-chat-button" onclick="startNewChat()" title="Start New Chat">ðŸ”„</button>
                <button class="close-button" onclick="closeChat()" title="Close Chat">âœ•</button>
            </div>
        </div>
        
        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="message bot-message">
                    Hey there! I'm Nafis Ahmed Khan ðŸ‘‹ Great to meet you! Feel free to ask me about my work, experiences, background, or just chat about anything. What would you like to know?
                </div>
            </div>
            
            <div class="input-form">
                <input 
                    type="text" 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="Your message" 
                    maxlength="500"
                >
                <button id="sendButton" class="send-button">âž¤</button>
            </div>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        // API base URL - update this if deployed elsewhere
        // Use relative URL to work both locally and in production
        const API_BASE_URL = window.location.origin;

        // Session management
        let currentSessionId = localStorage.getItem('nafis_chat_session_id');
        let currentUserId = localStorage.getItem('nafis_chat_user_id');
        
        // Generate user ID if not exists
        if (!currentUserId) {
            currentUserId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('nafis_chat_user_id', currentUserId);
        }

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.textContent = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message typing';
            typingDiv.textContent = 'Typing...';
            typingDiv.id = 'typing';
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeTyping() {
            const typingDiv = document.getElementById('typing');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            messagesContainer.appendChild(errorDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Load conversation history for current session
        async function loadSessionHistory() {
            if (!currentSessionId) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/${currentSessionId}/history`);
                if (!response.ok) return; // Session doesn't exist or error
                
                const data = await response.json();
                
                // Clear current messages (keep welcome message)
                const welcomeMessage = messagesContainer.querySelector('.message.bot-message');
                messagesContainer.innerHTML = '';
                if (welcomeMessage) {
                    messagesContainer.appendChild(welcomeMessage);
                }
                
                // Add historical messages
                data.messages.forEach(msg => {
                    if (msg.role === 'user') {
                        addMessage(msg.content, true);
                    } else if (msg.role === 'assistant') {
                        addMessage(msg.content, false);
                    }
                });
                
            } catch (error) {
                console.error('Error loading session history:', error);
            }
        }

        // Function to start a new chat session
        function startNewChat() {
            currentSessionId = null;
            localStorage.removeItem('nafis_chat_session_id');
            
            // Clear messages (keep welcome message)
            const welcomeMessage = messagesContainer.querySelector('.message.bot-message');
            messagesContainer.innerHTML = '';
            if (welcomeMessage) {
                messagesContainer.appendChild(welcomeMessage);
            }
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, true);
            messageInput.value = '';
            sendButton.disabled = true;
            showTyping();

            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        session_id: currentSessionId,
                        user_id: currentUserId
                    }),
                });

                removeTyping();

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to get response');
                }

                const data = await response.json();
                addMessage(data.response);
                
                // Save session ID for future requests
                if (data.session_id && data.session_id !== currentSessionId) {
                    currentSessionId = data.session_id;
                    localStorage.setItem('nafis_chat_session_id', currentSessionId);
                }

            } catch (error) {
                removeTyping();
                console.error('Error:', error);
                showError(`Error: ${error.message}`);
            } finally {
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Close chat function (to be called from parent window or iframe)
        function closeChat() {
            // Try to communicate with parent window to close the iframe
            try {
                if (window.parent && window.parent !== window) {
                    // We're in an iframe, send message to parent
                    window.parent.postMessage('closeChat', '*');
                } else {
                    // We're in the main window, just hide or go back
                    window.history.back();
                }
            } catch (e) {
                // Fallback: try to close or go back
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    window.close();
                }
            }
        }

        // Get URL parameters and customize iframe
        function initializeFromParams() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Customize title
            const title = urlParams.get('title');
            if (title) {
                document.getElementById('headerTitle').textContent = title;
                document.title = title;
            }
            
            // Customize icon
            const icon = urlParams.get('icon');
            if (icon) {
                document.getElementById('headerIcon').textContent = icon;
            }
            
            // Customize welcome message
            const welcomeMessage = urlParams.get('welcome');
            if (welcomeMessage) {
                const botMessages = document.querySelectorAll('.bot-message');
                if (botMessages.length > 0) {
                    botMessages[0].textContent = decodeURIComponent(welcomeMessage);
                }
            }
            
        }

        // Initialize on page load
        async function initializeChat() {
            initializeFromParams();
            await loadSessionHistory(); // Load previous conversation if exists
            messageInput.focus();
        }
        
        // Initialize everything when page loads
        initializeChat();
    </script>
</body>
</html>
