<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nafis Ahmed Khan - AI Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --vh: 1vh; /* CSS custom property for viewport height */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            margin: 0;
            padding: 0;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100); /* Use custom property with fallback */
            overflow: hidden;
            overscroll-behavior: none; /* Disable pull-to-refresh on mobile */
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation; /* Improve touch responsiveness */
        }

        .container {
            width: 100%;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100); /* Use custom property with fallback */
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            position: relative;
            min-height: 100vh;
            min-height: calc(var(--vh, 1vh) * 100);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            position: relative;
            box-shadow: 0 2px 20px rgba(102, 126, 234, 0.15);
            z-index: 10;
            min-height: 60px; /* Ensure header height consistency */
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            overflow: hidden;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .header-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .header h1 {
            font-size: 1.2em;
            margin: 0;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .header p {
            display: none;
        }

        .header-controls {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
        }

        .close-button, .new-chat-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .new-chat-button {
            font-size: 14px;
        }

        .close-button:hover, .new-chat-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 20px 120px 20px;
            background: transparent;
            scroll-behavior: smooth;
            overscroll-behavior: contain; /* Prevent overscroll issues */
            -webkit-overflow-scrolling: touch;
            min-height: 0; /* Allow flex item to shrink */
        }

        .messages::-webkit-scrollbar {
            width: 4px;
        }

        .messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 2px;
        }

        .messages::-webkit-scrollbar-thumb:hover {
            background: #bbb;
        }

        .message {
            margin-bottom: 16px;
            padding: 14px 18px;
            border-radius: 20px;
            max-width: 80%;
            word-wrap: break-word;
            animation: fadeIn 0.4s ease-out;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
            position: relative;
        }

        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            text-align: right;
            max-width: 80%;
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bot-message {
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            margin-right: auto;
            max-width: 80%;
            border: 1px solid rgba(102, 126, 234, 0.15);
            backdrop-filter: blur(10px);
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        .input-form {
            background: rgba(255, 255, 255, 0.95);
            padding: 18px 20px 22px 20px;
            border-top: 1px solid rgba(102, 126, 234, 0.15);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            z-index: 5;
            min-height: 60px; /* Ensure consistent input form height */
        }

        .message-input {
            width: 100%;
            padding: 14px 55px 14px 18px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 25px;
            font-size: 15px;
            outline: none;
            background: rgba(248, 249, 250, 0.8);
            transition: all 0.3s ease;
            box-sizing: border-box;
            backdrop-filter: blur(10px);
            font-family: inherit;
        }

        .message-input:focus {
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15), 0 2px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }

        .message-input::placeholder {
            color: #6c757d;
        }

        .send-button {
            position: absolute;
            right: 26px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            color: white;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .send-button:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #7c8df1 0%, #8b5fbf 100%);
        }

        .send-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: translateY(-50%) scale(1);
        }

        .typing {
            color: #6c757d;
            font-style: italic;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(15px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .error {
            background: #dc3545;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        /* Enhanced mobile responsiveness */
        @media (max-width: 768px) {
            body {
                overscroll-behavior-y: none; /* Prevent pull-to-refresh specifically on mobile */
                position: fixed; /* Prevent address bar issues */
                width: 100%;
            }
            
            .container {
                height: 100vh;
                height: 100dvh;
                min-height: -webkit-fill-available;
                position: relative;
                overflow: hidden;
            }
            
            .header {
                padding: 14px 16px;
                min-height: 56px;
                flex-shrink: 0;
            }
            
            .header h1 {
                font-size: 1.1em;
            }
            
            .header-icon {
                width: 32px;
                height: 32px;
                border: 1.5px solid rgba(255, 255, 255, 0.4);
            }
            
            .chat-container {
                height: calc(100vh - 56px);
                height: calc(100dvh - 56px);
                display: flex;
                flex-direction: column;
            }
            
            .messages {
                padding: 16px 16px 130px 16px;
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }
            
            .message {
                max-width: 90%;
                padding: 12px 16px;
                font-size: 15px;
                margin-bottom: 12px;
            }
            
            .input-form {
                padding: 16px 16px 20px 16px;
                min-height: 70px;
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
            }
            
            .message-input {
                padding: 12px 50px 12px 16px;
                font-size: 16px; /* Prevent zoom on iOS */
                border-radius: 22px;
            }
            
            .send-button {
                width: 34px;
                height: 34px;
                right: 22px;
                font-size: 15px;
            }
            
            .close-button,
            .new-chat-button {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            .header {
                padding: 12px 14px;
            }
            
            .messages {
                padding: 14px 14px 130px 14px;
            }
            
            .input-form {
                padding: 14px 14px 18px 14px;
            }
        }
        
        /* Landscape mobile orientation fixes */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 10px 16px;
                min-height: 48px;
            }
            
            .header h1 {
                font-size: 1em;
            }
            
            .messages {
                padding: 12px 16px 110px 16px;
            }
            
            .input-form {
                padding: 12px 16px 16px 16px;
                min-height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-icon" id="headerIcon">
                    <img src="/static/myphotolatest.png" alt="Nafis Ahmed Khan" onerror="this.style.display='none'; this.parentNode.innerHTML='ðŸ‘¤';">
                </div>
                <h1 id="headerTitle">Chat with Nafis</h1>
            </div>
            <div class="header-controls">
                <button class="new-chat-button" onclick="startNewChat()" title="Start New Chat">ðŸ”„</button>
                <button class="close-button" onclick="closeChat()" title="Close Chat">âœ•</button>
            </div>
        </div>
        
        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="message bot-message">
                    Hey there! I'm Nafis Ahmed Khan ðŸ‘‹ Great to meet you! Feel free to ask me about my work, experiences, background, or just chat about anything. What would you like to know?
                </div>
            </div>
            
            <div class="input-form">
                <input 
                    type="text" 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="Your message" 
                    maxlength="500"
                >
                <button id="sendButton" class="send-button">âž¤</button>
            </div>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        // API base URL - update this if deployed elsewhere
        // Use relative URL to work both locally and in production
        const API_BASE_URL = window.location.origin;

        // Session management
        let currentSessionId = localStorage.getItem('nafis_chat_session_id');
        let currentUserId = localStorage.getItem('nafis_chat_user_id');
        
        // Generate user ID if not exists
        if (!currentUserId) {
            currentUserId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('nafis_chat_user_id', currentUserId);
        }

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.textContent = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message typing';
            typingDiv.textContent = 'Typing...';
            typingDiv.id = 'typing';
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeTyping() {
            const typingDiv = document.getElementById('typing');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            messagesContainer.appendChild(errorDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Load conversation history for current session
        async function loadSessionHistory() {
            if (!currentSessionId) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/${currentSessionId}/history`);
                if (!response.ok) return; // Session doesn't exist or error
                
                const data = await response.json();
                
                // Clear current messages (keep welcome message)
                const welcomeMessage = messagesContainer.querySelector('.message.bot-message');
                messagesContainer.innerHTML = '';
                if (welcomeMessage) {
                    messagesContainer.appendChild(welcomeMessage);
                }
                
                // Add historical messages
                data.messages.forEach(msg => {
                    if (msg.role === 'user') {
                        addMessage(msg.content, true);
                    } else if (msg.role === 'assistant') {
                        addMessage(msg.content, false);
                    }
                });
                
            } catch (error) {
                console.error('Error loading session history:', error);
            }
        }

        // Function to start a new chat session
        function startNewChat() {
            currentSessionId = null;
            localStorage.removeItem('nafis_chat_session_id');
            
            // Clear messages (keep welcome message)
            const welcomeMessage = messagesContainer.querySelector('.message.bot-message');
            messagesContainer.innerHTML = '';
            if (welcomeMessage) {
                messagesContainer.appendChild(welcomeMessage);
            }
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, true);
            messageInput.value = '';
            sendButton.disabled = true;
            showTyping();

            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        session_id: currentSessionId,
                        user_id: currentUserId
                    }),
                });

                removeTyping();

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to get response');
                }

                const data = await response.json();
                addMessage(data.response);
                
                // Save session ID for future requests
                if (data.session_id && data.session_id !== currentSessionId) {
                    currentSessionId = data.session_id;
                    localStorage.setItem('nafis_chat_session_id', currentSessionId);
                }

            } catch (error) {
                removeTyping();
                console.error('Error:', error);
                showError(`Error: ${error.message}`);
            } finally {
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Close chat function (to be called from parent window or iframe)
        function closeChat() {
            // Try to communicate with parent window to close the iframe
            try {
                if (window.parent && window.parent !== window) {
                    // We're in an iframe, send message to parent
                    window.parent.postMessage('closeChat', '*');
                } else {
                    // We're in the main window, just hide or go back
                    window.history.back();
                }
            } catch (e) {
                // Fallback: try to close or go back
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    window.close();
                }
            }
        }

        // Check if we're running in an iframe
        function isInIframe() {
            try {
                return window.self !== window.top;
            } catch (e) {
                // If we can't access window.top due to cross-origin, we're probably in an iframe
                return true;
            }
        }

        // Get URL parameters and customize iframe
        function initializeFromParams() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Hide close button if not in iframe (standalone web page)
            const closeButton = document.querySelector('.close-button');
            if (!isInIframe()) {
                closeButton.style.display = 'none';
            }
            
            // Customize title
            const title = urlParams.get('title');
            if (title) {
                document.getElementById('headerTitle').textContent = title;
                document.title = title;
            }
            
            // Customize icon (for iframe usage)
            const icon = urlParams.get('icon');
            if (icon) {
                // If custom icon is provided via URL params, replace the image with emoji
                document.getElementById('headerIcon').innerHTML = icon;
            }
            
            // Customize welcome message
            const welcomeMessage = urlParams.get('welcome');
            if (welcomeMessage) {
                const botMessages = document.querySelectorAll('.bot-message');
                if (botMessages.length > 0) {
                    botMessages[0].textContent = decodeURIComponent(welcomeMessage);
                }
            }
            
        }

        // Initialize on page load
        async function initializeChat() {
            initializeFromParams();
            await loadSessionHistory(); // Load previous conversation if exists
            messageInput.focus();
        }
        
        // Prevent pull-to-refresh and handle mobile viewport issues
        
        let touchStartY = 0;
        
        document.addEventListener('touchstart', function(e) {
            touchStartY = e.touches[0].clientY;
        }, { passive: true });
        
        document.addEventListener('touchmove', function(e) {
            const touchY = e.touches[0].clientY;
            const touchDelta = touchY - touchStartY;
            
            // Prevent pull-to-refresh when scrolling down at the top of the page
            if (messagesContainer.scrollTop === 0 && touchDelta > 0) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Handle viewport height changes on mobile (keyboard show/hide)
        function handleViewportChange() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        window.addEventListener('resize', handleViewportChange);
        window.addEventListener('orientationchange', handleViewportChange);
        
        // Initialize viewport height
        handleViewportChange();
        
        // Initialize everything when page loads
        initializeChat();
    </script>
</body>
</html>
